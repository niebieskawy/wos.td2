<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>WOS TD2 - Generator ostrze≈ºe≈Ñ sta≈Çych</title>
    <style>
        :root {
            --bg: #f9f9f9;
            --text: #000;
            --container-bg: white;
            --border: #aaa;
            --shadow: rgba(0,0,0,0.15);
            --primary: #0d47a1;
            --primary-hover: #1565c0;
            --table-header: #e8e8e8;
            --station-header: #fffacd;
        }

        [data-theme="dark"] {
            --bg: #121212;
            --text: #e0e0e0;
            --container-bg: #1e1e1e;
            --border: #444;
            --shadow: rgba(0,0,0,0.6);
            --primary: #4a90e2;
            --primary-hover: #6aa8f7;
            --table-header: #2a2a2a;
            --station-header: #3a3a3a;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 20px;
            background: var(--bg);
            color: var(--text);
            transition: background 0.4s, color 0.4s;
        }

        h1 { color: var(--primary); text-align: center; margin-bottom: 0.4em; }

        .container {
            background: var(--container-bg);
            padding: 20px;
            border: 1px solid var(--border);
            max-width: 1500px;
            margin: 0 auto 30px;
            box-shadow: 0 2px 10px var(--shadow);
            border-radius: 8px;
            transition: all 0.4s;
        }

        label { display: block; margin: 12px 0 4px; font-weight: bold; }

        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: monospace;
            font-size: 1.05em;
            background: var(--container-bg);
            color: var(--text);
            box-sizing: border-box;
        }

        button {
            padding: 10px 22px;
            margin: 12px 12px 12px 0;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        button:hover { background: var(--primary-hover); }

        .wos-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9.5pt;
            margin-top: 12px;
        }

        .wos-table th, .wos-table td {
            border: 1px solid var(--border);
            padding: 4px 6px;
            text-align: center;
            vertical-align: middle;
        }

        .wos-table th { background-color: var(--table-header); font-weight: bold; }

        .wos-table .station-header {
            background-color: var(--station-header);
            font-size: 11pt;
            font-weight: bold;
            text-align: left;
            padding-left: 12px;
            height: 30px;
        }

        /* Prze≈ÇƒÖcznik motywu ‚Äì prawy g√≥rny r√≥g */
        .theme-toggle {
            position: fixed;
            top: 16px;
            right: 20px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        [data-theme="dark"] .theme-toggle {
            background: rgba(30,30,30,0.9);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .theme-toggle span {
            font-size: 24px;
        }

        @media print {
            .no-print, .theme-toggle { display: none !important; }
            body { margin: 0; background: white; }
            .container { border: none; box-shadow: none; padding: 0; margin: 0; }
        }
    </style>
</head>
<body data-theme="light">

<!-- Prze≈ÇƒÖcznik motywu -->
<div class="theme-toggle" onclick="toggleTheme()" title="Zmie≈Ñ motyw">
    <span id="theme-icon">‚òÄÔ∏è</span>
</div>

<div class="container no-print">
    <h1>Wykaz Ostrze≈ºe≈Ñ Sta≈Çych (WOS) ‚Äì TD2</h1>

    <label for="maszynista">Maszynista:</label>
    <select id="maszynista" required>
        <option value="" disabled selected>≈Åadowanie aktywnych maszynist√≥w...</option>
    </select>

    <div style="margin-top: 16px;">
        <button onclick="generujWOS()">Generuj WOS</button>
        <button onclick="window.print()">Drukuj / Zapisz jako PDF</button>
    </div>
</div>

<div class="container">
    <div id="wynik"></div>
</div>

<script type="module">
    import { BAZA_OSTRZEZEN } from './baza.js';

    async function zaladujMaszynistow() {
        const select = document.getElementById('maszynista');
        try {
            const response = await fetch('https://stacjownik.spythere.eu/api/getActiveData', { cache: 'no-cache' });
            if (!response.ok) throw new Error(`API: ${response.status}`);
            const data = await response.json();
            const maszynisci = new Set();
            if (Array.isArray(data)) {
                data.forEach(train => {
                    if (train?.driverName?.trim()) maszynisci.add(train.driverName.trim());
                });
            }
            select.innerHTML = '<option value="" disabled selected>Wybierz maszynistƒô</option>';
            if (maszynisci.size === 0) {
                select.innerHTML += '<option disabled>Brak aktywnych maszynist√≥w</option>';
                return;
            }
            [...maszynisci].sort((a,b)=>a.localeCompare(b,'pl')).forEach(nick => {
                const opt = document.createElement('option');
                opt.value = nick;
                opt.textContent = nick;
                select.appendChild(opt);
            });
        } catch (err) {
            console.error('B≈ÇƒÖd pobierania maszynist√≥w:', err);
            select.innerHTML = '<option disabled>B≈ÇƒÖd ≈Çadowania listy</option>';
        }
    }

    document.addEventListener('DOMContentLoaded', zaladujMaszynistow);

    document.getElementById('maszynista').addEventListener('change', function() {
        if (this.value) generujWOS();
    });

    function toggleTheme() {
        const body = document.body;
        const current = body.getAttribute('data-theme') || 'light';
        const next = current === 'light' ? 'dark' : 'light';
        body.setAttribute('data-theme', next);
        document.getElementById('theme-icon').textContent = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        localStorage.setItem('theme', next);
    }

    // Przywracanie zapamiƒôtanego motywu
    if (localStorage.getItem('theme') === 'dark' ||
        (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.body.setAttribute('data-theme', 'dark');
        document.getElementById('theme-icon').textContent = 'üåô';
    }

    function generujWOS() {
        const maszynista = document.getElementById("maszynista").value || "‚Äî";
        let lp = 1;
        let html = `
        <h1 style="margin:0 0 12px; font-size:15pt; text-align:center;">
            Wykaz Ostrze≈ºe≈Ñ Sta≈Çych<br>
            oraz prƒôdko≈õci drogowych na torach g≈Ç√≥wnych zasadniczych
        </h1>
        <p style="text-align:center; margin-bottom:12px;">
            Maszynista: <strong>${maszynista}</strong>
        </p>
        <table class="wos-table">
          <thead>
            <tr>
              <th class="col-nr">Lp.</th>
              <th colspan="2">Lokalizacja ograniczenia<br>lub prƒôdko≈õci drogowej</th>
              <th class="col-przyczyna">Przyczyna ograniczenia</th>
              <th class="col-tor">Nr toru</th>
              <th colspan="2">Prƒôdko≈õƒá do km/h<br>w kierunku</th>
              <th class="col-uwagi">Uwagi<br>Nr zmiany</th>
            </tr>
            <tr>
              <th>1</th>
              <th>od km</th>
              <th>do km</th>
              <th>4</th>
              <th>5</th>
              <th>nieparzystym</th>
              <th>parzystym</th>
              <th>9</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p style="text-align:center; color:#c00; margin-top:30px; font-size:14pt;">
            <b>Wybierz maszynistƒô, aby zobaczyƒá ostrze≈ºenia</b>
        </p>`;
        document.getElementById("wynik").innerHTML = html;
    }
</script>
</body>
</html>
